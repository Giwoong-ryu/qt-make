# 영상 클립 선택 로직 문서

> QT 영상 배경 클립 선택 전략 (2026-01-20 확정)

---

## 🎯 문서 목적

이 문서는 **QT 영상 배경 클립 선택 로직의 설계 의도와 구현 근거**를 기록합니다.

### 왜 이 문서가 필요한가?

1. **복잡한 의사결정 과정 보존**: 여러 시행착오와 논의 끝에 확정된 로직
2. **Pexels 현실 반영**: "이상적인 설계"가 아닌 "실제로 작동하는 설계"
3. **유지보수 가이드**: 왜 이렇게 만들었는지 알아야 올바르게 수정 가능

---

## 🧩 핵심 문제 정의

### 문제 1: Pexels 영상 길이는 랜덤

**이상적인 세계**:
```
구간 30초 필요 → Pexels에서 정확히 30초 영상 선택 ✅
```

**현실**:
```
구간 30초 필요 → Pexels 검색 결과:
- 12초 (짧음)
- 17초 (짧음)
- 25초 (짧음)
- 45초 (김)
- 60초 (너무 김)

정확히 30초? 거의 없음! ❌
```

**해결 방향**:
- **긴 영상**: trim으로 잘라 쓰기
- **짧은 영상**: 반복 재생으로 채우기
- **사람 영상**: 반복하면 티 남 → trim만 사용

---

### 문제 2: 사람 영상은 반복하면 부자연스러움

**자연 풍경 (산, 일몰)**:
```
17초 영상 × 2번 반복 = 34초
→ 루프가 자연스러움 ✅
```

**사람 영상 (고개 숙이는 동작)**:
```
17초 영상 × 2번 반복 = 34초
→ "왜 또 고개 숙여?" 어색함 ❌
```

**해결 방향**:
- **자연 풍경**: 반복 재생 허용 (15-20초 영상 2번 반복)
- **사람 영상**: 반복 절대 금지 → 구간 길이 이상 영상 필수 → trim으로 정확히 맞춤

---

### 문제 3: 중간 구간은 영상이 가장 많이 필요함

**구조**:
```
[도입 1개] + [중간 3개] + [마무리 1개] = 총 5개 영상
```

**현실적 문제**:
- 중간 구간 = **3개 영상 필요** (가장 많음)
- Pexels에서 30-40초 영상 = 드물음
- → 대부분 15-20초 영상 선택 → 2번 반복 사용

**해결 방향**:
- 30-40초 영상 우선 (있으면 최고)
- 15-20초 영상 대안 (현실적으로 가장 많이 선택됨)

---

## 📋 전체 구조

QT 영상은 **5개 구간**으로 구성:

```
[도입] → [중간1] → [중간2] → [중간3] → [마무리]
 (1)      (2)       (3)       (4)        (5)
```

| 구간 | 타입 | 특징 | 왜 이렇게? |
|------|------|------|-----------|
| 도입 | `fixed_intro` | 성경 구절 끝나는 지점까지 (동적) | 성경 구절 길이가 매번 다름 (20-25초 범위) |
| 중간 1-3 | `flexible_middle` | 감정 분석 기반 전략 | QT 내용에 따라 pain/transition/solution 비율 변동 |
| 마무리 | `fixed_closing` | 자연스러운 종료 | 정확한 길이보다 자연스러운 흐름 우선 |

---

## 🎯 구간별 선택 전략

### 1. 도입 구간 (fixed_intro)

**목표**: 성경 구절이 끝나는 지점까지 **정확히** 맞추기

**구간 특성**:
- 예상 길이: 20-25초 (성경 구절 끝나는 동적 지점)
- 전략: `nature_calm` (차분한 산, 호수 풍경)

**영상 선택 규칙**:

```python
# 1순위: 25초 이상 영상
if 25초 이상 영상 있음:
    품질 점수 최고인 것 선택
    → trim: 성경 구절 끝나는 지점 (예: 20초)

# 2순위: 가장 긴 영상 (25초 미달 시)
else:
    가장 긴 영상 선택
    → trim: 성경 구절 끝나는 지점
```

**예시**:
- 성경 구절 20초에 끝남
- 30초 영상 선택
- 0-20초까지만 재생 (trim)

---

### 2. 중간 구간 (flexible_middle) - 자연 풍경

**목표**: 자연스러운 영상 흐름 (반복 재생 허용)

**구간 특성**:
- 예상 길이: 각 30초 (총 90초 / 3개 구간)
- 전략: `nature_calm`, `nature_bright` (감정 분석 기반)

**영상 선택 규칙** (2단계 우선순위):

```python
# 1순위: 30-40초 영상 (이상적)
if 30-40초 영상 있음:
    품질 점수 최고인 것 선택
    → 1번 재생 (반복 없음, 자연스러움)

# 2순위: 15-20초 영상 (대안)
elif 15-20초 영상 있음:
    품질 점수 최고인 것 선택
    → 2번 반복 (30-40초 커버)

# 3순위: 구간 길이의 절반에 가장 가까운 영상
else:
    target = 구간길이 / 2
    가장 가까운 영상 선택
    → 반복 재생
```

**현실적 예상**:
- 30-40초 영상: 드물음 (운 좋으면 1개)
- 15-20초 영상: **대부분 여기서 선택됨** (2번 반복)

**예시**:
- 중간 구간 30초 필요
- 17초 nature_calm 영상 선택
- 17초 × 2번 = 34초 재생 (4초 초과는 OK)

---

### 3. 중간 구간 (flexible_middle) - 사람 영상

**목표**: 사람 영상은 **반복 절대 금지** (티 남!)

**구간 특성**:
- 예상 길이: 30초
- 전략: `human` (후드 입은 실루엣, 고통 표현)

**영상 선택 규칙** (반복 절대 불가):

```python
# 1순위: 구간 길이 이상 영상 (이상적)
if 30초 이상 영상 있음:
    품질 점수 최고인 것 선택
    → trim: 정확히 30초까지만 (1개 영상)

# 2순위: 2개 영상 조합 (폴백 - 반복 대신!)
else:
    # 서로 다른 human 영상 2개 선택
    영상1 = 가장 긴 영상 (예: 17초)
    영상2 = 두 번째로 긴 영상 (예: 10초)

    → 영상1 + 영상2 = 27초 (3초 부족하지만 OK)
    → 또는 15초 + 22초 = 37초 (7초 초과 OK)

    ⚠️ 반복 절대 금지! 같은 영상 2번 X, 다른 영상 2개 O
```

**왜 다른가?**:
- 자연 풍경: 17초 × 2번 = 34초 (같은 영상 반복, 자연스러움 ✅)
- 사람 동작: 17초 + 10초 = 27초 (다른 영상 2개, 반복 안 함 ✅)
- ❌ 금지: 사람 17초 × 2 = "왜 또 고개 숙여?" (어색함!)

**예시 1 (이상적)**:
- 중간 구간 30초 필요 (human)
- 35초 영상 선택
- 0-30초까지만 재생 (trim, 1개 영상)

**예시 2 (폴백 - 2개 영상)**:
- 중간 구간 30초 필요 (human)
- 가장 긴 영상: 17초 (A)
- 두 번째: 10초 (B)
- A(17초) + B(10초) = 27초 재생 (3초 부족하지만 자연스러움)

---

### 4. 마무리 구간 (fixed_closing)

**목표**: 자연스러운 종료 (trim 안 함)

**구간 특성**:
- 예상 길이: 20-25초 (러프)
- 전략: `nature_bright` 또는 `nature_calm` (희망 키워드 기반)

**영상 선택 규칙**:

```python
# 1순위: 20-30초 영상
if 20-30초 영상 있음:
    품질 점수 최고인 것 선택
    → trim 안 함 (영상이 자연스럽게 끝남)

# 2순위: 가장 가까운 영상
else:
    구간 길이에 가장 가까운 영상 선택
    → trim 안 함
```

**예시**:
- 마무리 구간 20-25초
- 25초 영상 선택
- 전체 재생 (trim 안 함, 자연스러운 종료)

---

## 📊 전략별 선택 로직 요약

| 구간 | 전략 | 영상 선택 | 처리 방식 |
|------|------|-----------|-----------|
| **도입** | nature_calm | 25초+ | ✂️ trim (성경 구절 끝) |
| **중간 1-3** | nature_calm | 30-40초 우선<br>→ 15-20초 대안 | 🔁 반복 재생 OK |
| **중간 1-3** | nature_bright | 30-40초 우선<br>→ 15-20초 대안 | 🔁 반복 재생 OK |
| **중간 1-3** | human | 구간 길이 이상 | ✂️ trim (반복 절대 금지) |
| **마무리** | nature_bright/calm | 20-30초 | ➡️ 그대로 (자연 종료) |

---

## 🎬 실제 시나리오 예시

### 케이스 1: 일반적인 QT (2분)

```
[도입] 0-20초 (nature_calm)
→ 30초 영상 선택 → 0-20초 trim

[중간1] 20-50초 (human, pain)
→ 35초 영상 선택 → 0-30초 trim (반복 금지)

[중간2] 50-80초 (nature_calm, transition)
→ 17초 영상 선택 → 17초 × 2번 반복 = 34초

[중간3] 80-110초 (nature_bright, solution)
→ 35초 영상 선택 → 1번 재생 (반복 없음)

[마무리] 110-120초 (nature_bright)
→ 25초 영상 선택 → 그대로 재생 (자연 종료)

총 영상: 5개
```

### 케이스 2: Pexels 영상 부족 시 (2개 영상 조합)

```
[중간1] human 구간 30초 필요
→ 30초 이상 영상 없음
→ 17초 영상(A) + 10초 영상(B) 선택
→ A + B = 27초 재생 (3초 부족하지만 반복 안 함!)

[중간2] nature_calm 구간 30초 필요
→ 12초 영상만 있음
→ 12초 × 3번 반복 = 36초 (자연 풍경은 반복 OK)

[중간3] human 구간 30초 필요
→ 15초 영상(A) + 22초 영상(B) 선택
→ A + B = 37초 재생 (7초 초과 OK, 반복 안 함!)
```

---

## 🔑 핵심 원칙

### 1. 자연 풍경 vs 사람 영상

| 구분 | 반복 가능? | 이유 |
|------|-----------|------|
| **자연 풍경** | ✅ 가능 | 루프가 자연스러움 |
| **사람 영상** | ❌ 불가 | 동작 반복이 어색함 |

### 2. 정확도 요구 수준

| 구간 | 정확도 | 이유 |
|------|--------|------|
| **도입** | 🎯 정확 | 성경 구절 끝나는 지점에 딱 맞춰야 함 |
| **중간** | 🔵 대략 | ±5초 정도는 OK (반복 재생이므로) |
| **마무리** | 🟢 러프 | 자연스럽게 종료되면 됨 |

### 3. 영상 길이 우선순위

```
중간 구간 (자연 풍경):
1순위: 30-40초 (이상적, 1번 재생)
2순위: 15-20초 (현실적, 2번 반복) ← 실제로 가장 많이 선택됨
3순위: 구간/2 근처 (드물음)

중간 구간 (사람):
1순위: 구간 길이 이상 (trim으로 정확히, 1개 영상)
2순위: 2개 영상 조합 (17초 + 10초 = 27초, 반복 절대 금지!)
```

---

## 🚨 주의사항

### 1. 가장 긴 영상 선택 금지

```python
❌ 잘못된 코드:
selected = max(videos, key=lambda v: v.duration)
# → 60초, 90초 영상도 선택됨!

✅ 올바른 코드:
selected = min(videos, key=lambda v: abs(v.duration - target))
# → 구간 길이에 가장 가까운 영상 선택
```

### 2. human 전략 반복 금지 → 2개 영상 조합

```python
if strategy == "human":
    if 구간 길이 이상 영상 있음:
        # 1개 영상 trim
        trim_duration = segment_duration
    else:
        # 2개 영상 조합 (반복 대신!)
        영상1 = 가장 긴 영상
        영상2 = 두 번째 긴 영상
        additional_videos = [영상2]
        # 영상1 + 영상2 순차 재생
else:
    # 자연 풍경은 반복 재생 OK
    trim_duration = None
```

**핵심 차이**:
```
❌ 사람: 17초 × 2번 = 34초 (같은 영상 반복, 부자연스러움)
✅ 사람: 17초 + 10초 = 27초 (다른 영상 2개, 자연스러움)
✅ 자연: 17초 × 2번 = 34초 (같은 영상 반복, 자연스러움)
```

### 3. 도입 구간 동적 길이

```python
# ❌ 고정: intro_end = 15초
# ✅ 동적: intro_end = scripture_section.end_time (예: 20초)
```

---

## 📁 관련 파일

| 파일 | 역할 |
|------|------|
| [video_clip_selector.py](../backend/app/services/video_clip_selector.py) | 영상 클립 선택 로직 구현 |
| [fixed_segment_analyzer.py](../backend/app/services/fixed_segment_analyzer.py) | 구간 분석 (도입/중간/마무리 구분) |
| [background_video_search.py](../backend/app/services/background_video_search.py) | Pexels API 영상 검색 |
| [test_video_clip_selector.py](../test_video_clip_selector.py) | 테스트 스크립트 |

---

## 🔄 다음 단계

- [ ] Video Concatenator 구현
  - trim 처리
  - 반복 재생 처리 (자연 풍경)
  - **2개 영상 순차 재생 처리 (human)**
- [ ] FFmpeg 명령어 생성 로직
  - 단일 영상 trim: `ffmpeg -i input.mp4 -t 30 output.mp4`
  - 반복 재생: `ffmpeg -stream_loop 1 -i input.mp4 ...`
  - **2개 영상 concat**: `ffmpeg -f concat -i list.txt output.mp4`
- [ ] 영상 합성 테스트

---

**문서 버전**: v1.1
**작성일**: 2026-01-20
**최종 수정**: 2026-01-20

**변경 이력**:
- v1.1 (2026-01-20): human 전략 폴백을 "반복"에서 "2개 영상 조합"으로 변경
- v1.0 (2026-01-20): 초안 작성
